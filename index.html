<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu IPTV Player</title>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.js"></script>
    <style>
        :root { --sidebar-width: 300px; --bg-color: #121212; --accent: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* Lista de Canais (Sidebar) */
        #sidebar { 
            width: var(--sidebar-width); 
            background: var(--bg-color); 
            border-right: 1px solid #333; 
            display: flex; 
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #333; color: var(--accent); text-align: center; }
        .canal-item { 
            padding: 15px; 
            border-bottom: 1px solid #222; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 14px;
        }
        .canal-item:hover { background: #1e1e1e; color: var(--accent); }
        .canal-item.active { background: var(--accent); color: black; font-weight: bold; }

        /* Player */
        #main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        video { width: 100%; height: 100%; background: #000; }
        
        #unmute-notice {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255, 0, 0, 0.8); padding: 8px 15px;
            border-radius: 5px; cursor: pointer; z-index: 10; font-size: 12px;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">ðŸ“º MEUS CANAIS</div>
    <div id="lista-canais">Carregando lista...</div>
</div>

<div id="main-content">
    <div id="unmute-notice" onclick="unmute()" style="display:none;">ðŸ”ˆ Ativar Som</div>
    <video id="videoElement" controls autoplay muted playsinline></video>
</div>

<script>
    let player = null;
    const videoElement = document.getElementById('videoElement');
    const listaContainer = document.getElementById('lista-canais');
    const notice = document.getElementById('unmute-notice');

    // FunÃ§Ã£o para carregar e processar a lista M3U
    async function carregarLista() {
        const urlM3U = "https://raw.githubusercontent.com/ting560/tv/refs/heads/main/minha_lista_canais.m3u";
        try {
            const response = await fetch(urlM3U);
            const text = await response.text();
            const linhas = text.split('\n');
            let canaisHtml = '';
            
            for (let i = 0; i < linhas.length; i++) {
                if (linhas[i].startsWith('#EXTINF')) {
                    // Extrai o nome do canal
                    const nome = linhas[i].split(',')[1] || "Canal Sem Nome";
                    const linkOriginal = linhas[i+1].trim();
                    
                    if (linkOriginal) {
                        canaisHtml += `<div class="canal-item" onclick="trocarCanal('${linkOriginal}', this)">${nome}</div>`;
                    }
                }
            }
            listaContainer.innerHTML = canaisHtml;
        } catch (e) {
            listaContainer.innerHTML = "Erro ao carregar lista.";
        }
    }

    function trocarCanal(urlOriginal, elemento) {
        // Remove destaque do canal anterior
        document.querySelectorAll('.canal-item').forEach(el => el.classList.remove('active'));
        elemento.classList.add('active');

        // DestrÃ³i player anterior se existir
        if (player) {
            player.pause();
            player.unload();
            player.detachMediaElement();
            player.destroy();
        }

        // Prepara a URL via Proxy (encodando o link original para o proxy ler)
        const urlProxy = `/api/proxy?url=${encodeURIComponent(urlOriginal)}`;

        if (mpegts.getFeatureList().mseLivePlayback) {
            player = mpegts.createPlayer({
                type: 'mse', isLive: true, url: urlProxy
            }, {
                enableStashBuffer: false,
                stashInitialSize: 128
            });
            player.attachMediaElement(videoElement);
            player.load();
            player.play().catch(() => {
                notice.style.display = 'block';
            });
        }
    }

    function unmute() {
        videoElement.muted = false;
        notice.style.display = 'none';
    }

    carregarLista();
</script>

</body>
</html>
